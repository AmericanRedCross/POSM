# End-to-End Status

This attempts to capture the current status of POSM's usability from end-to-end,
both in terms of software installed and configured and data made available.

## Legend

:computer: - automated

:hand: - manual

:sunny: - good to go

:cloud: - partially working

:bomb: - not working / unknown

## Misc. Cloud Services

Description | Status | Notes | Owner | For Ecuador
----------- | ------ | ----- | ----- | ---------
1. Data gatherer | :bomb: | **TBD**, HOT Export Tool? | ? | No

## Misc. Device Services

Description | Status | Notes | Owner | For Ecuador
----------- | ------ | ----- | ----- | ---------
1. Static iD assets | :sunny: | | | Yes
2. Field Papers | :sunny: | | | Yes
3. OMK Server | :sunny: | | |  Yes
4. OSM API | :sunny: | openstreetmap-website, CGImap | | Yes
5. Captive Portal | :sunny: | `dnsmasq` | | Yes
6. WiFi | :sunny: | `hostapd` | | Yes
7. MBTiles server | :sunny: | `tessera` | | Yes
8. Tile renderer | :sunny: | `tessera` | | Yes
9. Device admin | :bomb: | **TBD** | | No

## Initial Data Gathering

Description | Automated | Status | Notes | Owner | Issues | For Ecuador
----------- | --------- | ------ | ----- | ----- | ------ |  --------
1. PBF Extract | :hand: | :cloud: | Overpass → XML → PBF (HOT Export Tool doesn't include metadata) | | | Yes
1a. Overpass → XML | :hand: | :cloud: | | | |  Yes
1b. XML → PBF conversion | :hand: | :cloud: | Osmosis | | |  Yes
2. MBTiles creation | :hand: | :cloud: | [tl](https://github.com/mojodna/tl) or [mbtiles-generate](https://github.com/AmericanRedCross/mbtiles-generate) (which uses `tl` internally) | | | Yes

### Outputs

Description | Status | Notes | Owner | For Ecuador
----------- | ------ | ----- | ----- | ------
1. AOI data package | :cloud: | HTTP-accessible, contains PBF + MBTiles (styles TBD) for the AOI. Generated by hand. | | Yes

## Initial Device Data Provisioning

Description | Automated | Status | Notes | Owner | For Ecuador
----------- | --------- | ------ | ----- | ----- | ---------
1. Download data package | :hand: | :cloud: | Target path: **TBD** (this is manual for now) | | Yes
2. Extract MBTiles | :hand: | :cloud: | Target path: `/opt/data/tiles` | | Yes
3. Extract PBF | :hand: | :cloud: | Target path: `/opt/data/osm` | | Yes
4. Populate APIDB<sup>1</sup> | :hand: | :bomb: | Osmosis | | Yes
5. Populate rendering DB | :hand: | :cloud: | `osm2pgsql` | | Maybe
6. Restart tile server(s) | :hand: | :cloud: | Manual | | Yes

1. To populate the APIDB (using scripts from [macrocosm](https://github.com/americanredcross/macrocosm)):

```bash
createdb macrocosm
psql -d macrocosm -f db-server/script/macrocosm-db.sql
osmosis \
  --read-pbf-fast delaware-latest.osm.pbf \
  --log-progress \
  --write-apidb database=macrocosm
```

### Outputs

Description | Status | Notes | Owner | For Ecuador
----------- | ------ | -----| ----- | -------
1. HTTP-accessible tiles | :sunny: | From MBTiles archive(s) | | Yes
2. HTTP-accessible tiles | :sunny: | Live rendered | | Maybe

## Field Papers

Description | Automated | Status | Notes | Owner | For Ecuador
----------- | --------- | ------ | ----- | ----- | -------
1. Generate PDF | :hand: | :sunny: | fp-legacy / fp-tasks | | Yes
2. Download, print, and annotate | :hand: | :sunny: | | | Yes
3. Upload | :hand: | :sunny: | fp-legacy / fp-tasks | | Yes
4. Trace in iD | :hand: | :cloud: | static iD, fp-tiler | | Maybe, depends on how/whether changesets can be extracted from the APIDB.

### Outputs

Description | Status | Notes | Owner | Issues | For Ecudador
----------- | ------ | ----- | ----- | ------ | -------
1. HTTP-accessible PDF | :sunny: | | | | Yes
2. HTTP-accessible snapshot GeoTIFF | :sunny: | | | | Yes
3. HTTP-accessible snapshot tiles | :sunny: | `fp-tiler` | | | Yes

## OSM Editing

Description | Automated | Status | Notes | Owner | For Ecuador
----------- | --------- | ------ | ----- | ----- | ------
1. Load data | :hand: | :cloud: | openstreetmap-website | | Maybe
2. Save changes | :hand: | :cloud: | openstreetmap-website | | Maybe

### Outputs

Description | Status | Notes | Owner | For Ecuador
----------- | ------ | ----- | ----- | --------
1. Changesets | :bomb: | Inherently in the APIDB, but maybe we want files at this stage too | | Yes

## OpenMapKit

### Server

Description | Automated | Status | Notes | Owner | For Ecuador
----------- | --------- | ------ | ----- | ----- | -------
1. Create form from XLS | :computer: | :cloud: | Working, bare-bones UI | Needs deep thought regarding constraints. | Yes
2. Declare a deployment | :hand: | :cloud: | We have a very basic notion of a `manifest.json` for a job service | | Maybe
3. Serve a deployment to client | :computer: | :cloud: | The UI for this will be in the Android app, just starting that... | | Yes
4. Serve forms to client | :computer: | :sunny: | Done. | | Yes
5. Receive submissions and write to file system | :computer: | :sunny: | Done. | | Yes
6. Aggregate / Export ODK submissions | :computer: | :cloud: | We don't have filters for that (not important now) | | Yes
7. Export OSM Submissions | :computer: | :cloud: | API is done, filters and aggregates. Needs web UI | | Yes

### Android

Description | Automated | Status | Notes | Owner | For Ecuador
----------- | --------- | ------ | ----- | -----
1. Get deployment | :hand: | :bomb: | Getting started creating UI and tasks to get deployment from server | | Yes
2. Get ODK Forms | :computer: | :sunny: | | | Yes
3. Integrate as plugin with ODK in survey workflow | :computer: | :sunny: | | | Yes
4. Select, tag, create POI | :computer: | :sunny: | | | Yes
5. Submit to server | :computer: | :sunny: | | | Yes


## Sync ↓

Description | Automated | Status | Notes | Owner | For Ecuador
----------- | --------- | ------ | ----- | ----- | ------
1. Regenerate AOI data package | :hand: | :bomb: |  | | No
2. Download data package | :hand: | :bomb: | Target path: **TBD**  | | No
3. Extract PBF | :hand: | :bomb: | Target path: **TBD**  | | No
4. Extract MBTiles | :hand: | :bomb: | Target path: **TBD**  | | No

## Sync ↑

Description | Automated | Status | Notes | Owner | For Ecuador
----------- | --------- | ------ | ----- | ----- | ------
1. Generate diff(s) from APIDB<sup>1</sup> | :hand: | :bomb: | Osmosis / `osmconvert` to go from DB → PBF and to generate `.osm` and/or `.osc` files. | | Maybe
2. Update diffs | :hand: | :bomb: | Staged for manual merging. Target: **TBD** | | No

1. Affected features in locally applied changesets need to be identified and renumbered if they did not previously exist.

## Periodic Tasks

Description | Automated | Status | Notes | Owner
----------- | --------- | ------ | ----- | -----
1. Sync APIDB → rendering DB| :hand: | :bomb: | Osmosis / `osm2pgsql` |
2. Flush tile cache | :hand: | :bomb: | Restart `tessera` |
